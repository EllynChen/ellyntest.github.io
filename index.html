<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Portal (SMART Demo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f8fafc; }
        
        /* 表格樣式 */
        .portal-table { width: 100%; text-align: left; border-collapse: collapse; }
        .portal-table th { background-color: #f1f5f9; color: #475569; padding: 12px; font-size: 0.9rem; border-bottom: 2px solid #e2e8f0; font-weight: 700; }
        .portal-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        .portal-table tr:hover { background-color: #f8fafc; cursor: pointer; transition: background 0.15s; }
        
        /* 標籤樣式 */
        .tag { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; margin-right: 4px; margin-bottom: 4px;}
        .tag-blue { background-color: #dbeafe; color: #1e40af; }
        .tag-red { background-color: #fee2e2; color: #991b1b; }
        .tag-gray { background-color: #f3f4f6; color: #4b5563; }

        /* 動畫 */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <div id="scene-loading" class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <h2 class="text-2xl font-bold text-gray-700">Patient Portal</h2>
        <p class="text-gray-500 text-sm mt-2">Connecting to FHIR Server...</p>
    </div>

    <div id="scene-app" class="hidden flex flex-col h-screen fade-in relative">
        
        <header class="bg-white h-16 border-b flex items-center justify-between px-6 flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded"><i class="fas fa-heartbeat"></i></div>
                <span class="font-bold text-xl text-slate-800 tracking-wide">Patient Portal</span>
                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">SMART Connected</span>
            </div>
            <div class="flex items-center gap-4 text-sm">
                <div class="flex items-center gap-2 text-slate-600 bg-slate-50 px-3 py-1.5 rounded-full border">
                    <i class="fas fa-user-md text-lg"></i> <span>Dr. Lin</span>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden relative">
            
            <main class="flex-1 bg-slate-50 p-8 overflow-y-auto w-full transition-all duration-300" id="main-panel">
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                    <h2 class="text-lg font-bold text-slate-700 mb-4 border-l-4 border-blue-500 pl-3">病患檢索條件</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">病歷號 (Chart No)</label>
                            <input type="text" id="q-chart" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="例如: 880123">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">身分證號 (ID No)</label>
                            <input type="text" id="q-id" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="例如: A123456789">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">姓名 (Name)</label>
                            <input type="text" id="q-name" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="例如: 王小明">
                        </div>
                    </div>

                    <div class="text-right">
                        <button onclick="doSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded-lg font-bold shadow-sm transition flex items-center justify-center ml-auto">
                            <i class="fas fa-search mr-2"></i> 查詢
                        </button>
                    </div>
                </div>

                <div id="panel-patient-list" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden fade-in">
                    <div class="px-6 py-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <span class="font-bold text-slate-700">搜尋結果</span>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-bold">Records found</span>
                    </div>
                    <table class="portal-table">
                        <thead><tr><th>病歷號</th><th>姓名</th><th>性別 / 生日</th><th>身分證號</th><th>功能</th></tr></thead>
                        <tbody id="tbody-patient"></tbody>
                    </table>
                </div>
            </main>

            <aside id="right-drawer" class="fixed inset-y-0 right-0 w-[600px] bg-white shadow-2xl z-40 transform translate-x-full transition-transform duration-300 ease-in-out border-l border-gray-200 flex flex-col">
                
                <div class="px-6 py-4 border-b flex justify-between items-center bg-blue-50">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800" id="drawer-title">--</h3>
                        <p class="text-xs text-slate-500" id="drawer-subtitle">--</p>
                    </div>
                    <button onclick="closeDrawer()" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 transition">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto bg-white relative">
                    <div id="drawer-list-view" class="p-0">
                        <div id="drawer-list-content"></div>
                    </div>
                    <div id="drawer-detail-view" class="hidden p-6 fade-in">
                        <button onclick="backToDrawerList()" class="mb-4 text-sm text-blue-600 hover:underline flex items-center font-bold">
                            <i class="fas fa-chevron-left mr-1"></i> 返回就醫列表
                        </button>
                        <div id="detail-content" class="space-y-6"></div>
                    </div>
                </div>
            </aside>

            <div id="drawer-backdrop" onclick="closeDrawer()" class="fixed inset-0 bg-black bg-opacity-20 z-30 hidden transition-opacity"></div>

        </div>
    </div>

    <script>
        // ==========================================
        // 1. Mock Data (處方結構已優化)
        // ==========================================
        const db = {
            "A123": {
                id: "A123", name: "王小明 (Wang, Xiao-Ming)", gender: "Male", dob: "1985-05-20", chart: "880123", govId: "A123456789",
                encounters: [
                    {
                        id: "ENC001", date: "2024-12-25", type: "家醫科門診", dr: "Dr. Lee",
                        conditions: ["J06.9 急性上呼吸道感染", "E11.9 第二型糖尿病", "K21.9 胃食道逆流"],
                        details: {
                            s: "喉嚨痛、吞嚥困難，咳嗽有痰約三天。最近血糖控制不佳。", 
                            o: "Throat redness(++), Tonsil enlargement(+). Chest: Clear.", 
                            // 修正：藥品改為物件結構
                            meds: [
                                { name: "Acetaminophen 500mg", usage: "1 TAB QID", route: "PO", days: "3" },
                                { name: "Medicon-A", usage: "1 TAB TID", route: "PO", days: "3" },
                                { name: "Metformin 500mg", usage: "1 TAB BID", route: "PO", days: "28" }
                            ],
                            labs: [
                                {n:"WBC", v:"12500 /uL", f:"High"}, 
                                {n:"CRP", v:"1.2 mg/dL", f:"High"},
                                {n:"Glucose AC", v:"145 mg/dL", f:"High"},
                                {n:"HbA1c", v:"7.2 %", f:"High"},
                                {n:"Creatinine", v:"1.1 mg/dL", f:"Normal"}
                            ]
                        }
                    },
                    {
                        id: "ENC002", date: "2024-10-12", type: "皮膚科門診", dr: "Dr. Chen",
                        conditions: ["L23.9 接觸性皮膚炎", "L50.0 過敏性蕁麻疹"],
                        details: {
                            s: "雙手前臂出現紅疹，發癢難耐。疑似接觸清潔劑。", 
                            o: "Skin rash over bilateral forearms. Weals(+).", 
                            meds: [
                                { name: "Allegra 60mg", usage: "1 TAB BID", route: "PO", days: "5" },
                                { name: "Rinderon V Cream", usage: "Apply BID", route: "Topical", days: "7" },
                                { name: "Calamine Lotion", usage: "Apply PRN", route: "Topical", days: "5" }
                            ],
                            labs: [
                                {n:"IgE Total", v:"250 IU/mL", f:"High"},
                                {n:"Eosinophil", v:"6.5 %", f:"High"}
                            ] 
                        }
                    }
                ]
            },
            "B456": {
                id: "B456", name: "林美珠 (Lin, Mei-Chu)", gender: "Female", dob: "1960-08-15", chart: "990567", govId: "B987654321",
                encounters: [
                    {
                        id: "ENC003", date: "2025-01-02", type: "心臟內科門診", dr: "Dr. Wang",
                        conditions: ["I10 原發性高血壓", "E78.5 高脂血症", "I25.10 冠狀動脈疾病"],
                        details: {
                            s: "定期回診，最近血壓控制穩定。無胸痛。", 
                            o: "BP: 130/80 mmHg, HR: 72 bpm. Heart: Regular.", 
                            meds: [
                                { name: "Norvasc 5mg", usage: "1 TAB QD", route: "PO", days: "28" },
                                { name: "Lipitor 10mg", usage: "1 TAB QD", route: "PO", days: "28" },
                                { name: "Bokey 100mg", usage: "1 TAB QD", route: "PO", days: "28" }
                            ],
                            labs: [
                                {n:"T-Cho", v:"190 mg/dL", f:"Normal"},
                                {n:"LDL-C", v:"110 mg/dL", f:"High"},
                                {n:"TG", v:"145 mg/dL", f:"Normal"},
                                {n:"GPT/ALT", v:"32 U/L", f:"Normal"}
                            ]
                        }
                    }
                ]
            }
        };

        // ==========================================
        // 2. 系統啟動
        // ==========================================
        window.onload = function() {
            setTimeout(() => {
                document.getElementById('scene-loading').classList.add('hidden');
                document.getElementById('scene-app').classList.remove('hidden');
            }, 1200);
        };

        let currentPatientId = null;

        // ==========================================
        // 3. 複合搜尋邏輯
        // ==========================================
        function doSearch() {
            const chart = document.getElementById('q-chart').value.trim();
            const govId = document.getElementById('q-id').value.trim();
            const name = document.getElementById('q-name').value.trim();
            
            const tbody = document.getElementById('tbody-patient');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Searching...</td></tr>';
            document.getElementById('panel-patient-list').classList.remove('hidden');

            setTimeout(() => {
                tbody.innerHTML = '';
                
                const results = Object.values(db).filter(p => {
                    let match = true;
                    if (chart && !p.chart.includes(chart)) match = false;
                    if (govId && !p.govId.includes(govId)) match = false;
                    if (name && !p.name.includes(name)) match = false;
                    
                    if (!chart && !govId && !name) return true; 
                    
                    return match;
                });

                if (results.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">查無資料</td></tr>';
                } else {
                    results.forEach(p => {
                        tbody.innerHTML += `
                            <tr onclick="openRightDrawer('${p.id}')">
                                <td class="font-mono text-blue-700 font-bold">${p.chart}</td>
                                <td class="font-bold">${p.name}</td>
                                <td>${p.gender} / ${p.dob}</td>
                                <td>${p.govId}</td>
                                <td><button class="text-xs bg-blue-600 text-white px-3 py-1 rounded font-bold hover:bg-blue-700 shadow-sm">調閱</button></td>
                            </tr>`;
                    });
                }
            }, 300);
        }

        // ==========================================
        // 4. 右側滑動面板邏輯
        // ==========================================
        
        function openRightDrawer(patientId) {
            currentPatientId = patientId;
            const p = db[patientId];
            
            document.getElementById('drawer-title').innerText = p.name;
            document.getElementById('drawer-subtitle').innerText = `Chart: ${p.chart} | ID: ${p.govId}`;
            
            renderDrawerList(p);

            document.getElementById('right-drawer').classList.remove('translate-x-full');
            document.getElementById('drawer-backdrop').classList.remove('hidden');
        }

        function closeDrawer() {
            document.getElementById('right-drawer').classList.add('translate-x-full');
            document.getElementById('drawer-backdrop').classList.add('hidden');
            setTimeout(backToDrawerList, 300);
        }

        function renderDrawerList(patient) {
            const container = document.getElementById('drawer-list-content');
            container.innerHTML = '';

            patient.encounters.forEach((enc, index) => {
                const dxTags = enc.conditions.slice(0, 2).map(c => 
                    `<span class="tag tag-blue">${c.split(' ')[0]}</span>`
                ).join('');
                const moreDx = enc.conditions.length > 2 ? `<span class="text-xs text-gray-400">+${enc.conditions.length - 2}</span>` : '';

                const item = document.createElement('div');
                item.className = "p-4 border-b border-gray-100 hover:bg-slate-50 cursor-pointer transition group";
                item.onclick = () => showDetailInDrawer(index);
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-lg text-slate-800 group-hover:text-blue-600 transition">${enc.date}</span>
                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">${enc.type}</span>
                    </div>
                    <div class="mb-2 text-sm text-gray-600"><i class="fas fa-user-md mr-1"></i> ${enc.dr}</div>
                    <div class="mb-1">${dxTags} ${moreDx}</div>
                    <div class="text-xs text-gray-400 mt-2 flex justify-end items-center group-hover:text-blue-500">
                        查看詳情 <i class="fas fa-arrow-right ml-1"></i>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // ==========================================
        // 5. 詳細資料 (在 Drawer 內顯示)
        // ==========================================
        
        function showDetailInDrawer(index) {
            const p = db[currentPatientId];
            const enc = p.encounters[index];
            const d = enc.details;

            document.getElementById('drawer-list-view').classList.add('hidden');
            document.getElementById('drawer-detail-view').classList.remove('hidden');

            const content = document.getElementById('detail-content');
            
            const conditionList = enc.conditions.map(c => 
                `<li class="mb-1 text-slate-700 flex items-start"><i class="fas fa-check-circle text-blue-500 mr-2 mt-1"></i><span>${c}</span></li>`
            ).join('');

            const labRows = d.labs.map(l => `
                <tr class="border-b last:border-0 hover:bg-gray-50">
                    <td class="py-2 text-gray-600">${l.n}</td>
                    <td class="py-2 font-bold text-gray-800">${l.v}</td>
                    <td class="py-2 text-right">${l.f === 'High' ? '<span class="tag tag-red">High</span>' : '<span class="text-green-500 text-xs"><i class="fas fa-check"></i></span>'}</td>
                </tr>
            `).join('');

            // 新增：用藥列表 HTML 產生器
            const medRows = d.meds.map(m => `
                <tr class="border-b last:border-0 hover:bg-yellow-50">
                    <td class="py-2 text-sm font-bold text-slate-700">${m.name}</td>
                    <td class="py-2 text-sm text-slate-600">${m.usage}</td>
                    <td class="py-2 text-sm text-slate-600">${m.route}</td>
                    <td class="py-2 text-sm text-slate-600 text-center">${m.days}</td>
                </tr>
            `).join('');

            content.innerHTML = `
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
                    <div class="flex justify-between font-bold text-lg mb-1">
                        <span>${enc.date}</span>
                        <span class="text-blue-600">${enc.type}</span>
                    </div>
                    <div class="text-sm text-gray-500">主治醫師: ${enc.dr}</div>
                </div>

                <div>
                    <h4 class="font-bold text-slate-700 border-b pb-2 mb-3"><i class="fas fa-clipboard-list mr-2"></i>診斷 (Diagnosis)</h4>
                    <ul class="text-sm pl-1">${conditionList}</ul>
                </div>

                <div>
                    <h4 class="font-bold text-slate-700 border-b pb-2 mb-3"><i class="fas fa-stethoscope mr-2"></i>SOAP 紀錄</h4>
                    <div class="text-sm space-y-2 bg-white p-2">
                        <div class="mb-2"><span class="font-bold text-gray-500 block mb-1">Subjective (主訴):</span> ${d.s}</div>
                        <div><span class="font-bold text-gray-500 block mb-1">Objective (客觀):</span> ${d.o}</div>
                    </div>
                </div>

                <div>
                    <h4 class="font-bold text-slate-700 border-b pb-2 mb-3"><i class="fas fa-pills mr-2"></i>處方用藥 (Medications)</h4>
                    <table class="w-full text-left">
                        <thead class="bg-yellow-100 text-yellow-800 text-xs uppercase">
                            <tr>
                                <th class="py-1 px-2 rounded-l">藥品名稱</th>
                                <th class="py-1 px-2">服法</th>
                                <th class="py-1 px-2">途徑</th>
                                <th class="py-1 px-2 rounded-r text-center">天數</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${medRows}
                        </tbody>
                    </table>
                </div>

                <div>
                    <h4 class="font-bold text-slate-700 border-b pb-2 mb-3"><i class="fas fa-flask mr-2"></i>檢驗報告 (Labs)</h4>
                    <table class="w-full text-sm">
                        ${labRows}
                    </table>
                </div>
            `;
        }

        function backToDrawerList() {
            document.getElementById('drawer-detail-view').classList.add('hidden');
            document.getElementById('drawer-list-view').classList.remove('hidden');
        }

    </script>
</body>
</html>
