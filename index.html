<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>門診病歷查詢工作站 (SMART Loading)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f1f5f9; }
        
        /* 表格與選單樣式 */
        .workstation-table { width: 100%; text-align: left; background: white; border-collapse: separate; border-spacing: 0; }
        .workstation-table th { background-color: #f8fafc; color: #475569; padding: 12px 16px; font-size: 0.9rem; border-bottom: 2px solid #e2e8f0; font-weight: 700; }
        .workstation-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        .workstation-table tr:hover { background-color: #eff6ff; cursor: pointer; transition: background 0.15s; }
        .menu-item { display: flex; align-items: center; padding: 12px 24px; color: #64748b; font-size: 0.95rem; font-weight: 500; transition: all 0.2s; border-right: 3px solid transparent; cursor: pointer; }
        .menu-item:hover { background-color: #f8fafc; color: #0f172a; }
        .menu-item.active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }

        /* 進度條動畫 */
        .progress-bar-fill {
            transition: width 10s linear; /* 10秒線性過渡 */
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <div id="scene-loading" class="fixed inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center">
        
        <div class="relative w-24 h-24 mb-8">
            <div class="absolute inset-0 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center text-blue-600 text-3xl animate-pulse">
                <i class="fas fa-fire"></i>
            </div>
        </div>

        <h2 class="text-2xl font-bold text-slate-700 mb-2 tracking-wide">門診病歷查詢工作站</h2>
        <p id="loading-status" class="text-slate-500 font-mono text-sm h-6">正在初始化 SMART App Launch...</p>

        <div class="w-72 h-1.5 bg-slate-200 rounded-full mt-8 overflow-hidden">
            <div id="loading-progress" class="h-full bg-blue-600 w-0 rounded-full progress-bar-fill"></div>
        </div>

        <div class="mt-4 text-xs text-slate-400">
            Connecting to FHIR Server (R4)...
        </div>
    </div>


    <div id="scene-app" class="hidden flex flex-col h-screen fade-in">
        <header class="bg-white h-16 border-b flex items-center justify-between px-6 flex-shrink-0 z-20 relative shadow-sm">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded"><i class="fas fa-laptop-medical"></i></div>
                <span class="font-bold text-lg text-slate-800 tracking-wide">門診病歷查詢工作站</span>
                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Online</span>
            </div>
            <div class="flex items-center gap-4 text-sm">
                <div class="flex items-center gap-2 text-slate-600 bg-slate-100 px-3 py-1.5 rounded-full">
                    <i class="fas fa-user-circle text-lg"></i> <span>林護理師</span>
                </div>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-white border-r flex flex-col py-6 flex-shrink-0 z-10">
                <nav class="space-y-1">
                    <div class="menu-item active"><i class="fas fa-search"></i><span>病患查詢</span></div>
                </nav>
            </aside>

            <main class="flex-1 bg-slate-50 p-8 overflow-y-auto relative">
                
                <div id="view-search" class="max-w-6xl mx-auto">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6">
                        <h2 class="text-lg font-bold text-slate-700 mb-4 border-l-4 border-blue-500 pl-3">病患檢索條件 (Patient Resource)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">病歷號 (identifier)</label>
                                <input type="text" id="q-chart" class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如: 880123">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">身分證號 (identifier)</label>
                                <input type="text" id="q-id" class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如: A123456789">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">姓名 (name)</label>
                                <input type="text" id="q-name" class="w-full border border-slate-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如: 王小明">
                            </div>
                        </div>
                        <div class="text-right">
                             <button onclick="doSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded font-bold shadow-sm transition"><i class="fas fa-search mr-2"></i> 執行複合查詢</button>
                        </div>
                    </div>
                    <div id="panel-patient-list" class="hidden bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                        <table class="workstation-table">
                            <thead><tr><th>病歷號 (ID)</th><th>姓名</th><th>性別 / 生日</th><th>身分證</th><th>操作</th></tr></thead>
                            <tbody id="tbody-patient"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-visit-list" class="hidden max-w-6xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="showView('view-search')" class="bg-white border px-4 py-2 rounded shadow-sm text-sm font-bold"><i class="fas fa-arrow-left mr-2"></i>回搜尋</button>
                        <div class="text-xl font-bold text-slate-800"><span id="vl-name" class="text-blue-600 mr-2">--</span> 的就醫紀錄 (Encounters)</div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                        <table class="workstation-table">
                            <thead><tr><th>就診日期</th><th>就診類型</th><th>主要診斷 (Condition)</th><th>詳情</th></tr></thead>
                            <tbody id="tbody-visit"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-detail" class="hidden max-w-6xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="backToVisitList()" class="bg-white border px-4 py-2 rounded shadow-sm text-sm font-bold"><i class="fas fa-arrow-left mr-2"></i>回就醫列表</button>
                        <div class="text-right">
                            <span id="dt-date" class="block text-2xl font-bold text-slate-800">--</span>
                            <span id="dt-dept" class="block text-sm text-slate-500 font-bold">--</span>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6">
                        <div class="flex items-center gap-2 border-b pb-3 mb-4">
                            <i class="fas fa-stethoscope text-blue-500"></i>
                            <h4 class="font-bold text-slate-700">SOAP 診療紀錄</h4>
                            <span class="text-xs text-gray-400 ml-auto font-mono">Res: ClinicalImpression</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Subjective (主訴)</span>
                                <p id="dt-s" class="text-slate-800 bg-slate-50 p-3 rounded border border-slate-100 leading-relaxed">--</p>
                            </div>
                            <div>
                                <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Objective (客觀檢查)</span>
                                <p id="dt-o" class="text-slate-800 bg-slate-50 p-3 rounded border border-slate-100 leading-relaxed">--</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-2">
                            <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Assessment (診斷)</span>
                            <p id="dt-a" class="text-blue-700 font-bold text-lg">--</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6">
                        <div class="flex items-center gap-2 border-b pb-3 mb-4">
                            <i class="fas fa-pills text-yellow-500"></i>
                            <h4 class="font-bold text-slate-700">處方用藥</h4>
                            <span class="text-xs text-gray-400 ml-auto font-mono">Res: MedicationRequest</span>
                        </div>
                        <ul id="dt-meds" class="space-y-2 text-sm text-slate-700 pl-4 list-disc marker:text-slate-300"></ul>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                        <div class="flex items-center gap-2 border-b pb-3 mb-4">
                            <i class="fas fa-flask text-red-500"></i>
                            <h4 class="font-bold text-slate-700">檢驗報告</h4>
                            <span class="text-xs text-gray-400 ml-auto font-mono">Res: Observation</span>
                        </div>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-600">
                                <tr>
                                    <th class="py-2 px-4 font-bold border-b">項目</th>
                                    <th class="py-2 px-4 font-bold border-b">數值</th>
                                    <th class="py-2 px-4 font-bold border-b text-center">異常</th>
                                </tr>
                            </thead>
                            <tbody id="dt-labs"></tbody>
                        </table>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. 自動載入邏輯 (Simulate Launch)
        // ==========================================
        
        window.onload = function() {
            // 頁面載入後，立即啟動進度條動畫
            setTimeout(() => {
                document.getElementById('loading-progress').style.width = '100%';
            }, 100);

            // 模擬各階段狀態文字更新
            const statusEl = document.getElementById('loading-status');
            
            setTimeout(() => { statusEl.innerText = "正在連接 FHIR 伺服器 (Handshaking)..."; }, 2000);
            setTimeout(() => { statusEl.innerText = "驗證醫事人員憑證 (OAuth 2.0)..."; }, 5000);
            setTimeout(() => { statusEl.innerText = "正在取得病患 Context 資料..."; }, 8000);
            
            // 10秒後切換到主畫面
            setTimeout(() => {
                document.getElementById('scene-loading').classList.add('hidden');
                document.getElementById('scene-app').classList.remove('hidden');
                // 預設進入搜尋頁
                showView('view-search');
            }, 10000);
        };

        // ==========================================
        // 2. Mock Data
        // ==========================================
        const db = {
            "A123": {
                id: "A123", name: "王小明", gender: "male", birthDate: "1985-05-20", chart: "880123", govId: "A123456789",
                encounters: [
                    {
                        date: "2024-12-25", type: "家醫科門診", dx: "急性上呼吸道感染",
                        details: {
                            s: "喉嚨痛、吞嚥困難，咳嗽有痰約三天。", 
                            o: "Throat redness(+). Breathing sound clear.", 
                            a: "Acute URI (J06.9)",
                            meds: ["Acetaminophen 500mg", "Medicon-A", "Transamin 250mg"],
                            labs: [{n:"WBC", v:"12500 /uL", f:"High"}, {n:"CRP", v:"1.2 mg/dL", f:"High"}]
                        }
                    },
                    {
                        date: "2024-10-12", type: "皮膚科門診", dx: "接觸性皮膚炎",
                        details: {
                            s: "雙手前臂出現紅疹，發癢難耐。", 
                            o: "Skin rash over bilateral forearms.", 
                            a: "Contact Dermatitis (L23.9)",
                            meds: ["Allegra 60mg", "Rinderon Cream"],
                            labs: [] 
                        }
                    }
                ]
            },
            "B456": {
                id: "B456", name: "林美珠", gender: "female", birthDate: "1960-08-15", chart: "990567", govId: "B987654321",
                encounters: [
                    {
                        date: "2025-01-02", type: "心臟內科門診", dx: "原發性高血壓",
                        details: {
                            s: "定期回診，血壓控制穩定。", 
                            o: "BP: 130/80 mmHg", 
                            a: "Essential Hypertension (I10)",
                            meds: ["Norvasc 5mg"],
                            labs: [{n:"HbA1c", v:"5.9 %", f:"Normal"}]
                        }
                    }
                ]
            }
        };

        let currentPatientId = null;
        const USE_FHIR = false;
        let fhirClient = null;

        // ==========================================
        // 3. 頁面控制
        // ==========================================
        function showView(viewId) {
            ['view-search', 'view-visit-list', 'view-detail'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        // ==========================================
        // 4. 搜尋與資料邏輯
        // ==========================================
        function doSearch() {
            const chart = document.getElementById('q-chart').value.trim();
            const govId = document.getElementById('q-id').value.trim();
            const name = document.getElementById('q-name').value.trim();
            
            const tbody = document.getElementById('tbody-patient');
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">查詢中...</td></tr>';
            document.getElementById('panel-patient-list').classList.remove('hidden');

            setTimeout(() => {
                tbody.innerHTML = '';
                // 複合篩選
                if (!chart && !govId && !name) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">請輸入查詢條件</td></tr>';
                    return;
                }

                const results = Object.values(db).filter(p => {
                    let match = true;
                    if (chart && !p.chart.includes(chart)) match = false;
                    if (govId && !p.govId.includes(govId)) match = false;
                    if (name && !p.name.includes(name)) match = false;
                    return match;
                });

                if (results.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">查無資料</td></tr>';
                } else {
                    results.forEach(p => {
                        tbody.innerHTML += `
                            <tr onclick="listVisits('${p.id}')">
                                <td class="font-mono text-blue-700">${p.chart}</td>
                                <td class="font-bold">${p.name}</td>
                                <td>${p.gender} / ${p.birthDate}</td>
                                <td>${p.govId}</td>
                                <td><button class="text-xs bg-blue-50 text-blue-600 border border-blue-200 px-3 py-1 rounded">選擇</button></td>
                            </tr>`;
                    });
                }
            }, 300);
        }

        function listVisits(patientId) {
            currentPatientId = patientId;
            const p = db[patientId];
            document.getElementById('vl-name').innerText = p.name;
            
            const tbody = document.getElementById('tbody-visit');
            tbody.innerHTML = '';

            p.encounters.forEach((enc, index) => {
                tbody.innerHTML += `
                    <tr onclick="showDetail(${index})">
                        <td class="font-bold text-slate-700">${enc.date}</td>
                        <td>${enc.type}</td>
                        <td>${enc.dx}</td>
                        <td class="text-center"><button class="text-xs bg-slate-100 px-3 py-1 rounded">查看</button></td>
                    </tr>`;
            });

            showView('view-visit-list');
        }

        function backToVisitList() {
            listVisits(currentPatientId);
        }

        function showDetail(index) {
            const p = db[currentPatientId];
            const enc = p.encounters[index];
            const d = enc.details;

            document.getElementById('dt-date').innerText = enc.date;
            document.getElementById('dt-dept').innerText = enc.type;

            document.getElementById('dt-s').innerText = d.s;
            document.getElementById('dt-o').innerText = d.o;
            document.getElementById('dt-a').innerText = d.a;

            document.getElementById('dt-meds').innerHTML = d.meds.map(m => `<li>${m}</li>`).join('');

            const labsTbody = document.getElementById('dt-labs');
            if(d.labs.length === 0) {
                labsTbody.innerHTML = '<tr><td colspan="3" class="py-4 text-center text-slate-400 italic">無檢驗資料</td></tr>';
            } else {
                labsTbody.innerHTML = d.labs.map(l => `
                    <tr class="border-b last:border-0 hover:bg-slate-50">
                        <td class="py-3 px-4 text-slate-700">${l.n}</td>
                        <td class="py-3 px-4 font-bold text-slate-800">${l.v}</td>
                        <td class="py-3 px-4 text-center">${l.f === 'High' ? '<span class="text-red-600 font-bold text-xs bg-red-100 px-2 py-0.5 rounded">High</span>' : '-'}</td>
                    </tr>`).join('');
            }
            showView('view-detail');
        }
    </script>
</body>
</html>
